const express = require('express');
const multer = require('multer');
const { execSync  } = require('child_process');
const path = require('path');
const fs = require('fs/promises');
const cors = require('cors');
const { stderr } = require('process');


const app = express();
const port = 3000;

const storage = multer.memoryStorage();
const upload = multer({ storage: storage });

app.use(express.static('public'));
app.use(cors());

app.post('/upload', upload.single('userFile'), async (req, res) => {
    try {
        const uploadedFile = req.file;
        if (!uploadedFile) {
            res.status(400).send('No file uploaded.');
            return;
        }

        // Save the uploaded file temporarily
        const tempFilePath = path.join(__dirname, 'uploads', uploadedFile.originalname);
        await fs.writeFile(tempFilePath, uploadedFile.buffer);
        const directoryPath = path.dirname(tempFilePath);

        const currentDirectory = path.join(__dirname);
const newDirectory = path.join(currentDirectory, 'ExeFolder');
const command = path.join(newDirectory, 'MEEDRMalwareClassifier.exe');

// Change the current working directory
process.chdir(newDirectory);

// Command to execute
const fullCommand = `${command} ${directoryPath}`;

try {
    // success command
    const resNpmVersion = execSync(fullCommand);
    //console.log("success", resNpmVersion.toString());
    let result = "";
    resNpmVersion.stdout.on('data',(data) => {
        result += data.toString();
    });

    resNpmVersion.on('close', (code) => {
        res.send(result);
    });

    // failed command, the result is printed in the catch block
    const resHelp = execSync("HELP");
} catch (error) {
    //console.log(error.message);
   // console.log("error result", error.stdout.toString());
    let result = error.stdout.toString();
        res.send(result);
}
        
    } catch (error) {
        console.error(error);
        res.status(500).send('Internal server error.');
    }
});

app.listen(port, () => {
    console.log(`Server is running on port ${port}`);
});